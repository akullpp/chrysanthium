<!doctype html>
<html lang="en">
  <head>
    <title>React Hook Form Auto Save || Chrysanthium</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="akullpp" />
    <meta name="description" content="About software engineering" />
    <meta name="email" content="akullpp@gmail.com" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:creator" content="" />
    <meta name="twitter:title" content="React Hook Form Auto Save" />
    <meta name="twitter:image" content="https://chrysanthium.com/logo.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/tomorrow.css">
  </head>

  <body>
    <header class="navigation">
      <ul>
        <li>
          <a href="/">Blog</a>
        </li>

        <li>
          <a href="/about">About</a>
        </li>
      </ul>
    </header>

    <h1>React Hook Form Auto Save</h1>
    
      <h6>2023/12</h6>
    

    <pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useCallback <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> debounce <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash-es'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useWatch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-hook-form'</span>
<span class="token keyword">import</span> type <span class="token punctuation">{</span> useForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-hook-form'</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> useDeepEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@leaf/ui-components/hooks/use-deep-effect'</span>

<span class="token keyword">const</span> useAutoSave <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token operator">:</span> ReturnType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeof</span> <span class="token attr-name">useForm</span><span class="token punctuation">></span></span><span class="token plain-text">, onSubmit: (data: unknown) => void) => </span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> watch <span class="token operator">=</span> <span class="token function">useWatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">control</span><span class="token operator">:</span> context<span class="token punctuation">.</span>control <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> isDirty <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>formState

  <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  <span class="token keyword">const</span> debouncedSave <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
    <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">handleSubmit</span><span class="token punctuation">(</span>onSubmit<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>

  <span class="token function">useDeepEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">debouncedSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>watch<span class="token punctuation">,</span> isDirty<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token plain-text">

export </span><span class="token punctuation">{</span> useAutoSave <span class="token punctuation">}</span><span class="token plain-text">
</span></code></pre>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useMemo<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isEqual <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash-es'</span>

type UseEffectParams <span class="token operator">=</span> Parameters<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeof</span> <span class="token attr-name">useEffect</span><span class="token punctuation">></span></span><span class="token plain-text">
type EffectCallback = UseEffectParams[0]
type DependencyList = UseEffectParams[1]
type UseEffectReturn = ReturnType</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeof</span> <span class="token attr-name">useEffect</span><span class="token punctuation">></span></span><span class="token plain-text">

const isPrimitive = (val: unknown) => </span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> val <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[sbn]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> val<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token plain-text">

const checkDeps = (deps: DependencyList) => </span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps <span class="token operator">||</span> <span class="token operator">!</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Use useEffect instead of useDeepEffect.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isPrimitive<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Use useEffect instead of useDeepEffect.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token plain-text">

/**
 * @param value the value to be memoized (usually a dependency list)
 * @returns a memoized version of the value as long as it remains deeply equal
 */
const useDeepCompareMemoize = </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">(value: T) => </span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">(value)
  const signalRef = useRef</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>number</span><span class="token punctuation">></span></span><span class="token plain-text">(0)

  console.log(ref.current, value, !isEqual(value, ref.current))
  if (!isEqual(value, ref.current)) </span><span class="token punctuation">{</span>
    ref<span class="token punctuation">.</span>current <span class="token operator">=</span> value
    signalRef<span class="token punctuation">.</span>current <span class="token operator">+=</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token plain-text">

  return useMemo(() => </span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> ref<span class="token punctuation">.</span>current
    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  <span class="token punctuation">}</span><span class="token plain-text">, [signalRef.current])
}

const useDeepEffect = (callback: EffectCallback, dependencies: DependencyList): UseEffectReturn => </span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DEV</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkDeps</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  <span class="token keyword">return</span> <span class="token function">useEffect</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token function">useDeepCompareMemoize</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token plain-text">

export </span><span class="token punctuation">{</span> useDeepEffect <span class="token punctuation">}</span><span class="token plain-text">
</span></code></pre>


    <footer class="navigation">
      <ul>
        <li>
          <a href="/privacy">Privacy</a>
        </li>

        <li>
          <a href="/legal">Legal</a>
        </li>
      </ul>
    </footer>
  </body>
</html>
