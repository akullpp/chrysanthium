<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load symlinked dependencies with webpack || Chrysanthium</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/tomorrow.css">
  </head>

  <body>
    <header class="navigation">
      <ul>
        <li>
          <a href="/">Blog</a>
        </li>

        <li>
          <a href="/about">About</a>
        </li>
      </ul>
    </header>

    <h1>Load symlinked dependencies with webpack</h1>
    
      <h6>2018/07</h6>
    

    <p>Sometimes you need to use a specific webpack loader for a dependency which is only available locally as a symlink via <code>npm link</code>. This might be the case if you require the processing of certain file types or the transpilation of ES2015+ files with <code>babel-loader</code> as it was in my case with <a href="https://storybook.js.org/">Storybook</a>. Unfortunately, if you face hidden webpack configurations like in <a href="https://github.com/facebook/create-react-app">create-react-app</a> or aforementioned Storybook this won't work out of the box and requires to overwrite the defaults.</p>
<p>A rough description of my use case is the locally linking of a CRA SPA as dependency and the import of it's components in a separate Storybook project where they are used and tested. However, the <code>node_modules</code> are typically excluded with the common default configuration since it would not only take an enormous amount of time and memory to process each applicable file but would also require very complex and rather individual configuration:</p>
<pre class="language-js"><code class="language-js"><span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'env'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p>The steps I had to do to achieve what I wanted:</p>
<ol>
<li>In the SPA directory execute <code>npm link</code>.</li>
<li>In the Storybook directory execute <code>npm link single-page-application</code>.</li>
<li>Create a custom webpack configuration to include the symlinked module</li>
</ol>
<p>There were a few issues with Storybook itself since it did use it's pre-defined <code>.babelrc</code> and didn't want to extend the rules. The solution is to</p>
<ul>
<li>overwrite the entire rules</li>
<li>disable the usage of <code>.babelrc</code></li>
<li>pass the <code>babel-loader</code> options programmatically</li>
</ul>
<p>Do not forget that you additionally have to install the each used loader as dependency.</p>
<p>However webpack couldn't resolve the real path to the symlinked module no matter what. The solution is actually the combination of <code>fs.realpathSync</code> with <code>path.resolve</code> to get the correct path on the file system. Here's what the final <code>webpack.config.js</code> looks like:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">baseConfig<span class="token punctuation">,</span> env<span class="token punctuation">,</span> defaultConfig</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  defaultConfig<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        __dirname<span class="token punctuation">,</span>
        fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>
          path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
            path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
              __dirname<span class="token punctuation">,</span>
              <span class="token string">'..'</span><span class="token punctuation">,</span>
              <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
              <span class="token string">'single-page-application'</span><span class="token punctuation">,</span>
              <span class="token string">'src'</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token string">'react'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">babelrc</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">return</span> defaultConfig
<span class="token punctuation">}</span></code></pre>
<p>A working example can be found on <a href="https://github.com/akullpp/linked-storybook">GitHub</a>.</p>


    <footer class="navigation">
      <ul>
        <li>
          <a href="/privacy">Privacy</a>
        </li>

        <li>
          <a href="/legal">Legal</a>
        </li>
      </ul>
    </footer>
  </body>
</html>
