<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JVM: Lightweight CSV to JSONB persistence || Chrysanthium</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/tomorrow.css">
  </head>

  <body>
    <header class="navigation">
      <ul>
        <li>
          <a href="/">Blog</a>
        </li>

        <li>
          <a href="/about">About</a>
        </li>
      </ul>
    </header>

    <h1>JVM: Lightweight CSV to JSONB persistence</h1>
    
      <h6>2021/06</h6>
    

    <p>Python has become the de facto language for data processing since it has easy to use and provides popular libraries like pandas. However, Excel or CSV processing can also be done by JVM languages in a concise and efficient manner.</p>
<p>We will look at a minimal use case that consists of uploading a CSV file, converting it to JSONB and persisting it in just a few lines of code. This approach is perfect for fast-moving targets, i.e. when you can't estimate future changes and have to be flexible.</p>
<p>For such a lightweight task, we recommend the following tools:</p>
<ul>
<li><a href="https://github.com/osiegmar/FastCSV">FastCSV</a></li>
<li><a href="https://jdbi.org/">JDBI</a></li>
</ul>
<p>Although you can use any JVM language and this particular example utilizes Kotlin.</p>
<h2>DB</h2>
<p>With the declarative approach of JDBI you will write your own SQL statements which allows for a maximum of flexibility and control. It requires some time to get used to if you relied too heavily on JPA in the past, but being comfortable with SQL is one of the essential skills you will need in your career.</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Repository <span class="token punctuation">{</span>

    <span class="token annotation builtin">@Transaction</span>
    <span class="token annotation builtin">@SqlUpdate</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"CREATE TABLE IF NOT EXISTS foo(data JSONB)"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token annotation builtin">@Transaction</span>
    <span class="token annotation builtin">@SqlUpdate</span><span class="token punctuation">(</span>
        <span class="token string-literal multiline"><span class="token string">"""
        DELETE FROM foo WHERE data -> 'id' = to_jsonb(:id);
        INSERT INTO foo(data) VALUES(:data);
        """</span></span>
    <span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation builtin">@Json</span> <span class="token keyword">data</span><span class="token operator">:</span> Foo<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>We need two methods:</p>
<ul>
<li><code>init</code> to create the table if it doesn't exist, because we want maximum flexibility and don't want to maintain migrations in this phase</li>
<li><code>save</code> which conveniently overwrites an existing record based on an identifier</li>
</ul>
<p>The statements are self-explanatory and follow the <a href="https://www.postgresql.org/docs/9.4/functions-json.html">PostgreSQL JSONB syntax</a>.</p>
<h2>API</h2>
<p>So we want to keep this lightweight which means no model, service or additional layers. Especially no mappings to and from DTOs. Therefore, we should only have one additional class on top of the repository to save and retrieve data. Let us take a typical Spring REST controller and add a POST method to upload the CSV:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">typealias</span> Foo <span class="token operator">=</span> MutableMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span>

<span class="token annotation builtin">@RestController</span>
<span class="token keyword">class</span> <span class="token function">Api</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> jdbi<span class="token operator">:</span> Jdbi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation builtin">@EventListener</span><span class="token punctuation">(</span>ApplicationReadyEvent<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> jdbi<span class="token punctuation">.</span><span class="token function">useExtensionUnchecked</span><span class="token punctuation">(</span>
      Repository<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
      Repository<span class="token operator">::</span><span class="token keyword">init</span>
    <span class="token punctuation">)</span>

    <span class="token annotation builtin">@PostMapping</span>
    <span class="token keyword">fun</span> <span class="token function">upload</span><span class="token punctuation">(</span>@<span class="token annotation builtin">@RequestParam</span> file<span class="token operator">:</span> MultipartFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> rows <span class="token operator">=</span> NamedCsvReader<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>inputStream<span class="token punctuation">.</span><span class="token function">bufferedReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span>fields <span class="token punctuation">}</span>

        <span class="token keyword">return</span> jdbi<span class="token punctuation">.</span><span class="token function">useExtensionUnchecked</span><span class="token punctuation">(</span>Repository<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          it<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Since we don't rely on migrations we are going to create the table on application start, if you do not use Spring you can also go with Kotlin's <code>init</code> object.</p>
<p>If you have a row with header's you should use the <code>NamedCsvReader</code> otherwise the <code>CsvReader</code> is fine. FastCSV automatically parses the CSV into a <code>Map&lt;String, String&gt;</code> and JDBI will serialize it via Jackson. For convenience we use a typealias for this datastructure. Although you can also use Jackson to parse the CSV, we recommend FastCSV since you will have a better time extending the code with validation logic and common CSV options.</p>
<h2>Addendum</h2>
<p>If you tried the example you might need some additional configuration to make JDBI work with Kotlin, the following dependencies are recommended:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">object</span> Versions <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> jdbi <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"3.20.0"</span></span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> fastcsv <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"2.0.0"</span></span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> jacksonJsr310 <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"2.12.3"</span></span>
<span class="token punctuation">}</span>

<span class="token comment">// Kotlin</span>
<span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"org.jetbrains.kotlin:kotlin-reflect"</span></span><span class="token punctuation">)</span>
<span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"org.jetbrains.kotlin:kotlin-stdlib-jdk8"</span></span><span class="token punctuation">)</span>

<span class="token comment">// Jackson</span>
<span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.fasterxml.jackson.module:jackson-module-kotlin"</span></span><span class="token punctuation">)</span>
<span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.fasterxml.jackson.datatype:jackson-datatype-jsr310:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">Versions<span class="token punctuation">.</span>jacksonJsr310</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment">// DB</span>
<span class="token function">implementation</span><span class="token punctuation">(</span>"org<span class="token punctuation">.</span>jdbi<span class="token operator">:</span>jdbi3<span class="token operator">-</span>kotlin<span class="token operator">:</span>$<span class="token punctuation">{</span>Versions<span class="token punctuation">.</span>jdbi"<span class="token punctuation">)</span>
<span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"org.jdbi:jdbi3-kotlin-sqlobject:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">Versions<span class="token punctuation">.</span>jdbi</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"org.jdbi:jdbi3-jackson2:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">Versions<span class="token punctuation">.</span>jdbi</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"org.jdbi:jdbi3-postgres:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">Versions<span class="token punctuation">.</span>jdbi</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment">// Misc</span>
<span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"de.siegmar:fastcsv:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">Versions<span class="token punctuation">.</span>fastcsv</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></code></pre>
<p>To make this all work in harmony, you'll need following configuration:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Configuration</span>
<span class="token keyword">class</span> Configuration <span class="token punctuation">{</span>

    <span class="token annotation builtin">@Bean</span>
    <span class="token keyword">fun</span> <span class="token function">jdbi</span><span class="token punctuation">(</span>dataSource<span class="token operator">:</span> DataSource<span class="token punctuation">)</span><span class="token operator">:</span> Jdbi <span class="token punctuation">{</span>
        <span class="token keyword">val</span> jdbi <span class="token operator">=</span> Jdbi<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">installPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// Take Jackson's Kotlin version</span>
        <span class="token keyword">val</span> mapper <span class="token operator">=</span> <span class="token function">jacksonObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// Add Java 8 time</span>
        mapper<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token function">JavaTimeModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// Register custom Jackson mapper</span>
        jdbi<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>Jackson2Config<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span><span class="token punctuation">.</span>mapper <span class="token operator">=</span> mapper
        <span class="token keyword">return</span> jdbi
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>


    <footer class="navigation">
      <ul>
        <li>
          <a href="/privacy">Privacy</a>
        </li>

        <li>
          <a href="/legal">Legal</a>
        </li>
      </ul>
    </footer>
  </body>
</html>
