<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building base images for multiple languages and versions || Chrysanthium</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/tomorrow.css">
  </head>

  <body>
    <header class="navigation">
      <ul>
        <li>
          <a href="/">Blog</a>
        </li>

        <li>
          <a href="/about">About</a>
        </li>
      </ul>
    </header>

    <h1>Building base images for multiple languages and versions</h1>
    
      <h6>2021/07</h6>
    

    <p>It is good practice to have your own base images which you can modify for security, deployment or application-specific reasons. Obviously, they also need to be handled by your CI/CD and pushed to your container registry.</p>
<p>In this example, we assume a CI/CD with Bitbucket Pipelines and infrastructure on AWS. But the general idea should be applicable to every alternative, which is the following folder structure:</p>
<pre class="language-sh"><code class="language-sh">  golang/
    <span class="token number">1.16</span>/
      .latest
      Dockerfile
  python/
    <span class="token number">3.8</span>/
      Dockerfile
    <span class="token number">3.9</span>/
      .latest
      Dockerfile</code></pre>
<p>As you can see each <em>language</em> has its own folder and each subfolder is used for a specific <em>version</em>.</p>
<p>The idea is to produce an image by concatenating <code>language:version</code> and if the <code>.latest</code> file is present additionally the image <code>language:latest</code>.</p>
<p>The first thing to do, aside from creating a Git repository for this folder, is to set up the following environment variables in your CI/CD. In a Bitbucket repository these are called Repository Variables and can be found in the Settings of the repository:</p>
<ul>
<li><code>AWS_ACCESS_KEY</code></li>
<li><code>AWS_SECRET_ACCESS_KEY</code></li>
<li><code>AWS_REGION</code></li>
<li><code>AWS_ECR</code> has the form of <code>&lt;ACCOUNT&gt;.dkr.ecr.&lt;REGION&gt;.amazonaws.com</code></li>
</ul>
<p>Which will then be used in the following script located at the root under <code>build.sh</code>:</p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Requires awscli v2"</span>

<span class="token comment"># Set up AWS</span>
aws configure <span class="token builtin class-name">set</span> aws_access_key_id <span class="token string">"<span class="token variable">${AWS_ACCESS_KEY}</span>"</span>
aws configure <span class="token builtin class-name">set</span> aws_secret_access_key <span class="token string">"<span class="token variable">${AWS_SECRET_ACCESS_KEY}</span>"</span>

<span class="token comment"># Ensure it is called with a specific language folder</span>
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"Missing directory"</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token assign-left variable">DIR</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$1</span>"</span>
<span class="token assign-left variable">TARGET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> $1<span class="token variable">)</span></span>
<span class="token assign-left variable">TAG</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $1<span class="token variable">)</span></span>
<span class="token assign-left variable">IMAGE</span><span class="token operator">=</span><span class="token variable">$AWS_ECR</span>/<span class="token variable">$TARGET</span>

<span class="token comment"># Check for latest version file and set flag if true</span>
<span class="token assign-left variable">LATEST</span><span class="token operator">=</span>false
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$DIR</span>/.latest"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token assign-left variable">LATEST</span><span class="token operator">=</span>true
<span class="token keyword">fi</span>

<span class="token builtin class-name">echo</span> <span class="token string">"---"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"REGION=<span class="token variable">$AWS_REGION</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"IMAGE=<span class="token variable">$IMAGE</span>:<span class="token variable">$TAG</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"---<span class="token entity" title="\n">\n</span>"</span>

<span class="token comment"># Login to ECR</span>
aws ecr get-login-password <span class="token parameter variable">--region</span> <span class="token variable">$AWS_REGION</span> <span class="token operator">|</span> <span class="token function">docker</span> login <span class="token parameter variable">--username</span> AWS --password-stdin <span class="token variable">$AWS_ECR</span>

<span class="token comment"># Build and push tagged image</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> <span class="token variable">$IMAGE</span><span class="token builtin class-name">:</span><span class="token variable">$TAG</span> <span class="token variable">$DIR</span> <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> push <span class="token variable">$IMAGE</span><span class="token builtin class-name">:</span><span class="token variable">$TAG</span>

<span class="token comment"># Build and push latest image if .latest exists</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$LATEST</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">docker</span> build <span class="token parameter variable">-t</span> <span class="token variable">$IMAGE</span>:latest <span class="token variable">$DIR</span> <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> push <span class="token variable">$IMAGE</span>:latest
<span class="token keyword">fi</span>

<span class="token comment"># Return exit code of the last command</span>
<span class="token builtin class-name">exit</span> <span class="token variable">$?</span></code></pre>
<p>This requires you to have a build image for your pipeline with AWS and Docker installed, an exercise left to the reader. And do not forget to create the folders on ECR first!</p>
<p>Because it would be tedious to call this script with <code>./build.sh &lt;language&gt;/&lt;version&gt;</code> we will hand this over to <code>bitbucket-pipelines.yml</code>:</p>
<pre class="language-yml"><code class="language-yml"><span class="token key atrule">image</span><span class="token punctuation">:</span> &lt;USE A BUILD IMAGE THAT HAS AWS CLI INSTALLED OR CREATE YOUR OWN<span class="token punctuation">></span>

<span class="token key atrule">options</span><span class="token punctuation">:</span>
  <span class="token key atrule">max-time</span><span class="token punctuation">:</span> <span class="token number">5</span>

<span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
  <span class="token key atrule">custom</span><span class="token punctuation">:</span>
    <span class="token key atrule">python</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">step</span><span class="token punctuation">:</span>
          <span class="token key atrule">script</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> ./build.sh python/3.8
            <span class="token punctuation">-</span> ./build.sh python/3.9
          <span class="token key atrule">services</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> docker
    <span class="token key atrule">golang</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">step</span><span class="token punctuation">:</span>
          <span class="token key atrule">script</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> ./build.sh golang/1.16
          <span class="token key atrule">services</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> docker</code></pre>
<p>We utilize the manually triggered custom pipelines here and call the build script on each <code>&lt;language&gt;:&lt;version&gt;</code> path combination.</p>
<p>Because my <code>Dockerfile</code> always installs <code>awscliv2</code> among other things I push it once to be used in this pipeline, e.g. for <code>Python@3.8</code>:</p>
<pre class="language-dockerfile"><code class="language-dockerfile"><span class="token instruction"><span class="token keyword">FROM</span> python:3.8</span>

<span class="token comment"># Install awscli and kubectl</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; <span class="token operator">\</span>
apt-get install --no-install-recommends -y unzip &amp;&amp; <span class="token operator">\</span>
curl -L <span class="token string">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> -o <span class="token string">"awscliv2.zip"</span> &amp;&amp; <span class="token operator">\</span>
unzip awscliv2.zip &amp;&amp; <span class="token operator">\</span>
./aws/install &amp;&amp; <span class="token operator">\</span>
curl -L -o /opt/kubectl <span class="token string">"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"</span> &amp;&amp; <span class="token operator">\</span>
chmod +x /opt/kubectl &amp;&amp; <span class="token operator">\</span>
ln -s /opt/kubectl /bin/kubectl &amp;&amp; <span class="token operator">\</span>
apt-get remove -y unzip</span>

<span class="token comment"># Install additional tools</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get install --no-install-recommends -y gettext-base jq &amp;&amp; <span class="token operator">\</span>
rm -rf /var/lib/apt/lists/*</span>

<span class="token comment"># Install python-related stuff</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install poetry</span></code></pre>
<p>Finally, I set up a weekly schedule for each custom pipeline on Bitbucket:</p>
<p><img src="images/bitbucket_schedules.png" alt="Bitbucket Schedules"></p>


    <footer class="navigation">
      <ul>
        <li>
          <a href="/privacy">Privacy</a>
        </li>

        <li>
          <a href="/legal">Legal</a>
        </li>
      </ul>
    </footer>
  </body>
</html>
