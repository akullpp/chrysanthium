<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUID as silver bullet || Chrysanthium</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/tomorrow.css">
  </head>

  <body>
    <header class="navigation">
      <ul>
        <li>
          <a href="/">Blog</a>
        </li>

        <li>
          <a href="/about">About</a>
        </li>
      </ul>
    </header>

    <h1>UUID as silver bullet</h1>
    
      <h6>2019/04</h6>
    

    <p>We narrow down UUIDs to the ones defined by <a href="https://tools.ietf.org/html/rfc4122">RFC4122</a> which are therefore 128-bit long values consisting of 36 characters of the form <code>xxxxxxxx-xxxx-Axxx-Bxxx-xxxxxxxxxxxx</code> where <code>A</code> is the version and <code>B</code> the variant. For general use version 4, which draws from a random distribution, is commonly used which leaves 122 bits randomly generated ensuring that collision probability is close to zero. Read up the theoretical background information in the <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">Wikipedia article</a> if you would like, since we will focus on practical issues. For generated sequences this comparison assumes 64-bit integers between -2^63 and 2^63 - 1 where the sequence is those of natural numbers.</p>
<blockquote>
<p>The main benefit of global uniqueness lies in systems where the IDs are generated by the application, not the database which amplifies if multiple clients can write to multiple databases</p>
</blockquote>
<p>Take an event-sourced CQRS architecture for example, where in strict design the commands are not allowed to return a value as compared to a classical approach where methods commonly return a reference. If the consumer creates the ID it not only holds the reference in memory but also a valid state of the aggregate and therefore can continue to do work.</p>
<p>There are also some <strong>minor benefits</strong> which you can mention in an argument for UUIDs:</p>
<ol>
<li>You want to migrate data from an existing database to another database without worrying about conflicts</li>
<li>You want to implement high-performance equality checks and hash codes relatively easy, i.e. UUIDs are unique and not nullable</li>
<li>You want security through obscurity if you give the entity ID to consumers, i.e. enumeration becomes more difficult.</li>
</ol>
<p>However, I would argue that if you do not have a distributed system where multiple clients can write, you will certainly not need an UUID as primary identifier in your databases. Even then there are often high-performance solutions to create unique integer identifiers with <a href="https://github.com/twitter-archive/snowflake/tree/snowflake-2010">Twitter's snowflake algorithm</a> or a centralized database service.</p>
<blockquote>
<p>You never need an UUID as primary identifier there is only a single database node for writing</p>
</blockquote>
<p>Often the best solution to the issue at hand is to use a natural identifier which can be hashed and therefore will work in distributed systems with multiple write nodes.</p>
<p>The inherent issue comes from the <a href="https://en.wikipedia.org/wiki/B-tree#Insertions_and_deletions">B-tree data structure</a> used by databases which makes an insert <a href="http://kccoder.com/mysql/uuid-vs-int-insert-performance">very costly</a> by splitting the entire tree. Also you need to be careful that the database uses a native implementation and not just a <code>CHAR(36)</code> string which are 36 bytes or 16 bytes if optimized. This could easily break your neck, performance wise, since it can top the threshold for in-memory usage and will take vastly more space since foreign references add up.</p>
<h2>Real human beans</h2>
<p>Another big issue which often gets overlooked is that UUIDs on the consumer-side are not human friendly. Think about a dialogue on the support hotline:</p>
<pre><code>Supporter: &quot;Which order are you talking about&quot;
Customer: &quot;Oh, itâ€™s 2f52b103-82ff-4d17-a58d-3add255d4624.&quot;
</code></pre>
<p>Some people advocate that this problem can be solved by using a hashing algorithm to reduce the number of characters, but does <code>a6A4Xde2!=4</code> really sound better?</p>
<p>What you generally can do is to differentiate between external and internal IDs, so you could internally use UUIDs to avoid clashes and externally generate an identifier which is human-friendly if you are concerned about readability. Or you do it the other way around if you are concerned about performance and internally use a custom integer which does not need to be a sequence.</p>
<h2>Spring problems</h2>
<p>You use Spring Data JPA? Then I have got bad news for you, look at <code>SimpleJPARepository#save</code>:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>entityInformation<span class="token punctuation">.</span><span class="token function">isNew</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  em<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> entity<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> em<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>The <code>isNew</code>-method returns <code>true</code> if the ID is <code>null</code> otherwise he needs to do a <code>SELECT</code> before, instead of just one <code>INSERT</code> statement. One solution is to create a versionized field and a custom <code>equals</code> and of course the <code>hashCode</code> method:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">UUID</span> uuid<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Version</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> version<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> field<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token class-name">String</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field <span class="token operator">=</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token class-name">UUID</span> uuid<span class="token punctuation">,</span> <span class="token class-name">String</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>uuid <span class="token operator">=</span> uuid<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field <span class="token operator">=</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Data</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Data</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> data<span class="token punctuation">.</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>


    <footer class="navigation">
      <ul>
        <li>
          <a href="/privacy">Privacy</a>
        </li>

        <li>
          <a href="/legal">Legal</a>
        </li>
      </ul>
    </footer>
  </body>
</html>
