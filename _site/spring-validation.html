<!doctype html>
<html lang="en">
  <head>
    <title>Spring Validation || Chrysanthium</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="akullpp" />
    <meta name="description" content="About software engineering" />
    <meta name="email" content="akullpp@gmail.com" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:creator" content="" />
    <meta name="twitter:title" content="Spring Validation" />
    <meta name="twitter:image" content="https://chrysanthium.com/logo.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/post.css">
    <link rel="stylesheet" href="/css/tomorrow.css">
  </head>

  <body>
    <header class="navigation">
      <ul>
        <li>
          <a href="/">Blog</a>
        </li>

        <li>
          <a href="/about">About</a>
        </li>
      </ul>
    </header>

    <h1>Spring Validation</h1>
    
      <h6>2020/04</h6>
    

    <h2>Backend</h2>
<h3>Persistence Level</h3>
<p>The most important part is the <strong>database schema validation</strong> which must alway be reflected in the hibernate annotations of the entity. You have to do this validation with <a href="https://www.baeldung.com/javax-validation">bean validation</a> annotations. Please find the concrete implementation details in the <a href="https://docs.jboss.org/hibernate/stable/validator/reference/en-US/html_single/#validator-gettingstarted">hibernate validator documentation</a>. It is also possible to create <a href="https://www.baeldung.com/spring-mvc-custom-validator">custom annotation validations</a> which enable reuseability and readability. Here’s an example:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> foo {
  id  <span class="token keyword">BIGINT</span> PRIMARY_KEY<span class="token punctuation">,</span>
  bar <span class="token keyword">TEXT</span> NOT_NULL<span class="token punctuation">,</span>
  baz <span class="token keyword">BIGINT</span> <span class="token keyword">UNIQUE</span> NOT_NULL
}</code></pre>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Id</span>
  <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token constant">SEQUENCE</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span> updatable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@NotBlank</span>
  <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">"TEXT"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> bar<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@NotNull</span>
  <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Integer</span> baz<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>This is ensured by using the <code>ddl-auto: validate</code> property. The annotations <code>@Column(unique = true)</code> or <code>@UniqueConstraint</code> annotations do not validate, this is because these annotations only work when you create the database schema with the JPA provider. Nevertheless, it functions as documentation, so feel free to add it.</p>
<p>Obviously, these kind of errors are very serious and should not occur at runtime. Anyhow if they occur at runtime the exception should be mapped to an <code>500 INTERNAL_SERVER_ERROR</code> without any implementation internals revealed.</p>
<h3>Service Level</h3>
<p>Since services can communicate with different consumers, e.g. HTTP, protocol buffers, messaging queues or even just other services they also need to ensure the validity of the input in a sensible way. So do not assume just you have validated something in a REST controller, that it does not have to be validated on the service.</p>
<p>Also unboxing can play an additional implicit role in validation, e.g.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@Valid</span> <span class="token class-name">DTO</span> dto<span class="token punctuation">)</span></code></pre>
<p>Important here is that the errors thrown are generally service-level errors which should be remapped to controller-level error responses, typically via the global controller advices. It’s generally fine for service-level errors to be runtime exceptions that use technical keys, e.g. <code>DUPLICATE_USER</code> with additional - but not implementation or platform details - context provided to the consumer, e.g. provided parameters.</p>
<p>The service-level exceptions should always have a common base class:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FooException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FooException</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>which then can be extended for specific exceptions:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FooNotFoundException</span> <span class="token keyword">extends</span> <span class="token class-name">FooException</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">FooNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">"FOO_NOT_FOUND"</span><span class="token punctuation">,</span> <span class="token string">"Foo could not be retrieved from database"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3>Side Note: Optional &amp; Either</h3>
<p>This concept plays well with the <code>Optional</code> type in Java, e.g. if you have the case where an entity is not found with a well-formed identifier, this is almost always no exception for the service therefore the implementation should follow the guidelines of Spring and return an <code>Optional&lt;?&gt;</code> to the caller which then can decide if it’s an error or not.</p>
<p>An additional great concept to pass exceptions to the caller without causing too much overhead is to use the <strong>functional pattern of Either</strong> described <a href="https://www.ibm.com/developerworks/library/j-ft13/index.html">here</a>, e.g.:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Either</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">,</span> <span class="token class-name">Foo</span><span class="token punctuation">></span></span> <span class="token function">parseFoo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">Foo</span> foo<span class="token punctuation">)</span></code></pre>
<h3>Side Note: Logging</h3>
<p>This is also the layer where typically the most logging is done, a good approach is to have the following statement at the top of the class:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>It is important to utilize multiple levels of logging which means also to log happy path information for tracing/debugging purposes. A great way to log entire beans is utilizing org.apache.commons.lang3.builder.ReflectionToStringBuilder:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">ReflectionToStringBuilder</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2>Controller Level</h2>
<p>Response objects don’t need to be validated.</p>
<p>Request objects should always validate the expected form. Even if we have only one consumer currently, it is highly possible that we will provide the APIs to other, even third-party consumers. You can do this with the same <code>javax.validation</code> annotations, e.g.:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FooRequest</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Email</span>
  <span class="token annotation punctuation">@NotBlank</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Future</span>
  <span class="token annotation punctuation">@NotNull</span>
  <span class="token keyword">private</span> <span class="token class-name">ZonedDateTime</span> sendAt<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>The specific controller’s endpoint should look like this:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FooResponse</span><span class="token punctuation">></span></span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">FooRequest</span> request<span class="token punctuation">)</span></code></pre>
<p>It is worthy to note that while something may not be an error on the service-level, on controller-level it definitely may be so, e.g. the service might return an empty <code>Optional</code> if an entity is not found which then gets remapped:</p>
<pre class="language-java"><code class="language-java">configService<span class="token punctuation">.</span><span class="token function">saveConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ResponseEntity</span><span class="token operator">::</span><span class="token function">ok</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token class-name">BadRequestException</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3>Controller Advice</h3>
<p>All uncaught exceptions get handled centrally with a exception-specific controller advice. The advices itself have precedence, e.g. to handle a specific <code>FooException</code> which should be the base class for all other specific exceptions, e.g. a <code>FooNotFoundException</code>:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@ControllerAdvice</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FooExceptionHandler</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@ResponseBody</span>
  <span class="token annotation punctuation">@ResponseStatus</span><span class="token punctuation">(</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">FooNotFoundException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">ExceptionResponse</span> <span class="token function">handleFooNotFoundException</span><span class="token punctuation">(</span><span class="token class-name">FooNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExceptionResponse</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@ResponseBody</span>
  <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">FooException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">ExceptionResponse</span> <span class="token function">handleFooException</span><span class="token punctuation">(</span><span class="token class-name">FooException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExceptionResponse</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre>
<p>Where the exception response should like this:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionResponse</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">UUID</span> id<span class="token punctuation">;</span>
  <span class="token class-name">String</span> key<span class="token punctuation">;</span>
  <span class="token class-name">String</span> message<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">ExceptionResponse</span><span class="token punctuation">(</span><span class="token class-name">FooException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"{} - {} - {}\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> key<span class="token punctuation">,</span> message<span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The context which needs to be logged or provided back to the user depends on the exception thrown, e.g. if there is a validation exception it should be indicated which field of the request was actually invalid and - if applicable - what form is expected. Important part is to be able to find the log fast by providing a unique identfier and in case of distributed systems an identifier of the caller.</p>
<p>All other exceptions at runtime that do not have explicit exception handlers should be handled by a general controller advice which is the last in the chain as indicated by precedence:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@ControllerAdvice</span>
<span class="token annotation punctuation">@Priority</span><span class="token punctuation">(</span><span class="token constant">LOWEST_PRECEDENCE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuntimeExceptionHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ResponseEntityExceptionHandler</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@ResponseBody</span>
  <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">ExceptionResponse</span> <span class="token function">handleRuntimeException</span><span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExceptionResponse</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>Frontend</h2>
<p>Our applications should utilize validation primarily to ensure a good user experience which means that the <strong>patterns used in frontend and backend need to be equal</strong>. Generally, you want to provide immediate visual feedback to the user at the earliest point possible and run at least the same validations as the backend controllers.</p>
<p>A good validation pattern is the so called Facebook validation, i.e.:</p>
<ol>
<li>Initially no validation is triggered, all fields are valid, untouched and the submit button is enabled.</li>
<li>If the submit button is pressed, all validations are triggered and validation messages are shown.</li>
<li>Entering a untouched field makes it dirty, which means validation is triggered on blur.</li>
</ol>


    <footer class="navigation">
      <ul>
        <li>
          <a href="/privacy">Privacy</a>
        </li>

        <li>
          <a href="/legal">Legal</a>
        </li>
      </ul>
    </footer>
  </body>
</html>
